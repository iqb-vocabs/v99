#!/usr/bin/env node
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var fs = require("fs");
var config_file_factory_1 = require("./config-file.factory");
var csv_factory_1 = require("./csv.factory");
var dataFolder = '.';
if (process.argv[2]) {
    dataFolder = "".concat(dataFolder, "/").concat(process.argv[2]);
}
function getNotationDeep(notation) {
    var firstLevel = notation.split(' ').length;
    if (firstLevel > 1) {
        return notation.split('.').length + 1;
    }
    return Math.max(1, notation.split('.').length);
}
function getPrefLabel(d, voc, numLang) {
    var labels = ["\"".concat(d.title, "\"@").concat(voc.title[0].lang)];
    if (numLang > 2) {
        labels.push("\"".concat(d.title_fr, "\"@").concat(voc.title[2].lang));
        labels.push("\"".concat(d.title_it, "\"@").concat(voc.title[3].lang));
        labels.push("\"".concat(d.title_rm, "\"@").concat(voc.title[4].lang));
    }
    if (numLang > 1) {
        labels.push("\"".concat(d.title_en, "\"@").concat(voc.title[1].lang));
    }
    return labels.join(',\n\t');
}
function getDefinition(d, voc, numLang) {
    var definitions = ["\"".concat(d.description, "\"@").concat(voc.title[0].lang)];
    if (numLang > 2) {
        if (d.description_fr)
            definitions.push("\"".concat(d.description_fr, "\"@").concat(voc.title[2].lang));
        if (d.description_it)
            definitions.push("\"".concat(d.description_it, "\"@").concat(voc.title[3].lang));
        if (d.description_rm)
            definitions.push("\"".concat(d.description_rm, "\"@").concat(voc.title[4].lang));
    }
    if (numLang > 1 && d.description_en) {
        definitions.push("\"".concat(d.description_en, "\"@").concat(voc.title[1].lang));
    }
    return definitions.join(',\n\t');
}
function getConceptSchemeStrings(configData, voc) {
    var numLang = configData.title.length;
    var langIdx;
    if (numLang === 2)
        langIdx = [0, 1].slice(0, numLang);
    else
        langIdx = [0, 2, 3, 4, 1].slice(0, numLang);
    var mainTitles = langIdx.map(function (i) { return "\"".concat(configData.title[i].value, " - ").concat(voc.title[i].value, "\"@").concat(voc.title[i].lang); }).join(',\n\t');
    var creators = langIdx.map(function (i) { return "\"".concat(configData.creator, "\"@").concat(voc.title[i].lang); }).join(',\n\t');
    var mainDescription = '';
    if (voc.description[0].value !== '') {
        mainDescription = voc.description.slice(0, numLang).map(function (d) { return "\"".concat(d.value, "\"@").concat(d.lang); }).join(',\n\t');
    }
    return { mainTitles: mainTitles, creators: creators, mainDescription: mainDescription };
}
var configData = config_file_factory_1.ConfigFileFactory.load(dataFolder);
if (configData) {
    var outputFolder_1 = configData.outDir || '.';
    if (configData.outDir && !fs.existsSync(outputFolder_1)) {
        fs.mkdirSync(outputFolder_1);
    }
    var fileList_1 = {};
    fs.readdirSync(dataFolder).forEach(function (file) {
        fileList_1[file.toUpperCase()] = "".concat(dataFolder, "/").concat(file);
    });
    var csvDelimiter_1 = configData.csv_delimiter || ';';
    var stoutBase_1 = '@prefix dct: <http://purl.org/dc/terms/>.\n' +
        '@prefix skos: <http://www.w3.org/2004/02/skos/core#>. \n' +
        '@prefix dc: <http://purl.org/dc/elements/1.1/>.\n' +
        "@prefix n0: <".concat(configData.base);
    configData.vocabularies.forEach(function (voc) {
        var vocFilename = fileList_1[config_file_factory_1.ConfigFileFactory.getFilenameSource(voc).toUpperCase()];
        if (!vocFilename) {
            console.log("\u001B[0;33mWARNING\u001B[0m file '".concat(dataFolder, "/").concat(voc.id, ".csv' not found - ignore"));
            return;
        }
        var outPath = "".concat(outputFolder_1, "/").concat(config_file_factory_1.ConfigFileFactory.getFilenameTarget(voc));
        var baseUrl = 'n0:';
        var _a = getConceptSchemeStrings(configData, voc), mainTitles = _a.mainTitles, creators = _a.creators, mainDescription = _a.mainDescription;
        // eslint-disable-next-line max-len
        var license = "".concat(configData.license ? "".concat(configData.license, ";\n") : '<https://creativecommons.org/publicdomain/zero/1.0/deed.de>;\n');
        var footer = "".concat(baseUrl, "\n") +
            '\ta skos:ConceptScheme;\n' +
            "\tdct:creator ".concat(creators, ";\n") +
            "\tdct:title ".concat(mainTitles, ";\n").concat(
            // eslint-disable-next-line max-len
            mainDescription ? "\tdct:description ".concat(mainDescription, ";\n") : "\tdc:title ".concat(mainTitles, ";\n\tdc:description ").concat(mainTitles, ";\n"), "\tdct:license ").concat(license) +
            '\tskos:hasTopConcept';
        var data = csv_factory_1.CsvFactory.load(vocFilename, csvDelimiter_1, false);
        if (data && data.length > 0) {
            console.log("Processing '".concat(vocFilename, "': ").concat(data.length, " records found"));
            var stout = "".concat(stoutBase_1, "/").concat(voc.id, "/>. \n\n");
            var urlStack = [baseUrl];
            var nodesStack = [];
            var bodyStack = [];
            var nodeNodesStack = [];
            var numLang = configData.title.length;
            for (var i = 0; i < data.length; i++) {
                var d = data[i];
                var deep = getNotationDeep(d.notation.toString().trim());
                var deepNext = (i + 1 < data.length) ? getNotationDeep(data[i + 1].notation.toString().trim()) : 1;
                var oldUrl = urlStack[urlStack.length - 1];
                var newUrl = "n0:".concat(d.id);
                var prefLabel = getPrefLabel(d, voc, numLang);
                var desc = getDefinition(d, voc, numLang);
                var body = "".concat(newUrl, "\n\ta skos:Concept;\n") +
                    "\tskos:inScheme ".concat(baseUrl, ";\n") +
                    "\tskos:notation \"".concat(d.notation, "\";\n").concat(oldUrl === baseUrl ? "\tskos:topConceptOf ".concat(oldUrl, ";\n") : "\tskos:broader ".concat(oldUrl, ";\n"), "\tskos:prefLabel ").concat(prefLabel);
                if (deepNext <= deep) {
                    if (d.description !== '') {
                        body += "; \n\tskos:definition ".concat(desc, ".\n");
                    }
                    else
                        body += '.\n';
                    nodesStack.push(newUrl);
                    stout += body;
                    if (deepNext < deep) {
                        nodeNodesStack.push(nodesStack);
                        var dif = deep - deepNext;
                        while (dif > 0) {
                            urlStack.pop();
                            var oldBody = bodyStack.pop();
                            var tempNodesStack = nodeNodesStack.pop();
                            if (tempNodesStack) {
                                oldBody += ";\n\tskos:narrower ".concat(tempNodesStack.join(',\n\t\t'), ".");
                                stout += "".concat(oldBody, "\n");
                            }
                            dif -= 1;
                        }
                        nodesStack = nodeNodesStack.pop();
                    }
                }
                else {
                    if (d.description !== '')
                        body += "; \n\tskos:definition ".concat(desc);
                    bodyStack.push(body);
                    nodesStack.push(newUrl);
                    nodeNodesStack.push(nodesStack);
                    nodesStack = [];
                    urlStack.push(newUrl);
                }
            }
            footer += "\n\t\t".concat(nodesStack.join(',\n\t\t'), ".");
            stout += footer;
            fs.writeFileSync(outPath, stout, { encoding: 'utf8' });
        }
        else {
            console.log("\u001B[0;33mWARNING\u001B[0m Errors in file '".concat(vocFilename, "' - ignore"));
        }
    });
}
//# sourceMappingURL=csv2ttl.js.map